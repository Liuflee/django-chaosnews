<div class="comment">
    <!-- Comentario principal -->
    <div class="parent-comment">
        <div class="comment-header">
            <img src="{{ comment.usuario.profile_image_url }}" alt="{{ comment.usuario.username }}" class="comment-user-image">
            <div class="comment-details">
                <strong>{{ comment.usuario.username }}</strong>
                <small class="text-muted">{{ comment.fecha }}</small>
            </div>
        </div>
        <p>{{ comment.contenido }}</p>
        <!-- Botón de like y botón de respuesta -->
        <div class="comment-actions">
            <button class="btn-like" data-url="{% url 'like_comentario' comment.id %}">
                <i class="fas fa-thumbs-up"></i> <span id="likes-count-{{ comment.id }}">{{ comment.likes.count }}</span>
            </button>
            <button class="btn-reply" onclick="toggleReplyForm('{{ comment.id }}')">Responder</button>
        </div>
    </div>
    <!-- Formulario de respuesta al comentario padre (siempre visible) -->
    <form id="reply-form-{{ comment.id }}" class="reply-form" style="display: none;" method="post" action="{% url 'comentar_noticia' comment.noticia.id %}">
        {% csrf_token %}
        <div class="form-group form-group-reply">
            <img src="{{ user.profile_image_url }}" alt="{{ user.username }}" class="comment-user-image">
            <textarea name="contenido" class="comment-reply-area" placeholder="Escribe tu respuesta" rows="0" required></textarea>
            <input type="hidden" name="parent_id" value="{{ comment.id }}">
        </div>
        <div class="text-right">
            <button type="submit" class="send-btn">
                <i class="fas fa-paper-plane"></i> Enviar
            </button>
        </div>
    </form>
    <!-- Botón para mostrar más comentarios (condicional) -->
    {% if comment.replies.count > 0 %}
    <button class="btn btn-toggle-replies" onclick="toggleReplies('{{ comment.id }}')">Ver más comentarios</button>
    {% endif %}
    <!-- Comentarios anidados (inicialmente ocultos) -->
    <div id="replies-{{ comment.id }}" class="replies" style="display: none;">
        {% for reply in comment.replies.all %}
        <div class="child">
            <div class="parent-comment">
                <div class="comment-header">
                    <img src="{{ reply.usuario.profile_image_url }}" alt="{{ reply.usuario.username }}" class="comment-user-image">
                    <div class="comment-details">
                        <strong>{{ reply.usuario.username }}</strong>
                        <small class="text-muted">{{ reply.fecha }}</small>
                    </div>
                </div>
                <p>{{ reply.contenido }}</p>
                <!-- Botón de like y botón de respuesta -->
                <div class="comment-actions">
                    <button class="btn-like" data-url="{% url 'like_comentario' reply.id %}">
                        <i class="fas fa-thumbs-up"></i> <span id="likes-count-{{ reply.id }}">{{ reply.likes.count }}</span>
                    </button>
                    <button class="btn-reply" onclick="toggleReplyForm('{{ reply.id }}')">Responder</button>
                </div>
            </div>
            <!-- Formulario de respuesta -->
            <form id="reply-form-{{ reply.id }}" class="reply-form" method="post" action="{% url 'comentar_noticia' comment.noticia.id %}" style="display:none;">
                {% csrf_token %}
                <div class="form-group form-group-reply">
                    <img src="{{ user.profile_image_url }}" alt="{{ user.username }}" class="comment-user-image">
                    <textarea name="contenido" class="comment-reply-area" placeholder="Escribe tu respuesta" required></textarea>
                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                </div>
                <div class="text-right">
                    <button type="submit" class="send-btn">
                        <i class="fas fa-paper-plane"></i> Enviar
                    </button>
                </div>
            </form>
        </div>
        {% endfor %}
    </div>
</div>

<style>

</style>

<script>

document.addEventListener('DOMContentLoaded', function() {
    var replyForms = document.querySelectorAll('.comment-reply-area');

    replyForms.forEach(function(textarea) {
        textarea.addEventListener('input', function() {
            this.style.height = '30px'; // Resetea la altura para calcular correctamente el scrollHeight
            this.style.height = (this.scrollHeight) + 'px';
        });
    });
});


    function toggleReplyForm(commentId) {
        var form = document.getElementById('reply-form-' + commentId);
        if (form.style.display === 'none') {
            form.style.display = 'block';
        } else {
            form.style.display = 'none';
        }
    }

    function toggleReplies(commentId) {
        var replies = document.getElementById('replies-' + commentId);
        if (replies.style.display === 'none') {
            replies.style.display = 'block';
        } else {
            replies.style.display = 'none';
        }
    }

    document.querySelectorAll('.btn-like').forEach(button => {
        button.addEventListener('click', function() {
            var url = this.getAttribute('data-url');
            fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('likes-count-' + data.comment_id).textContent = data.likes_count;
                })
                .catch(error => console.error('Error:', error));
        });
    });
</script>
